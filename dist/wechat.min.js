import _regeneratorRuntime from 'babel-runtime/regenerator';
import _asyncToGenerator from 'babel-runtime/helpers/asyncToGenerator';
import wx from 'weixin-js-sdk';

function isWeChat() {
  return window.navigator.userAgent.toLowerCase().indexOf('micromessenger') > -1;
}

var cbList = [];
var firstEntry = true;

var loadWx = (function () {
  var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {
    var callback = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : function () {};
    var res;
    return _regeneratorRuntime.wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            if (isWeChat()) {
              _context.next = 2;
              break;
            }

            return _context.abrupt('return', true);

          case 2:
            if (firstEntry) {
              _context.next = 6;
              break;
            }

            cbList.push(callback);
            _context.next = 16;
            break;

          case 6:
            firstEntry = false;
            _context.next = 9;
            return requestJsbill();

          case 9:
            res = _context.sent;

            wx.config({
              debug: false,
              appId: res.data.appId,
              timestamp: res.data.timestamp,
              nonceStr: res.data.nonceStr,
              signature: res.data.signature,
              jsApiList: ['checkJsApi', 'openLocation', 'getLocation', 'onMenuShareTimeline', 'onMenuShareAppMessage', 'hideMenuItems', 'uploadImage', 'chooseImage', 'scanQRCode', 'chooseWXPay']
            });
            _context.next = 13;
            return new Promise(function (resolve, reject) {
              wx.ready(function () {
                return resolve();
              });
              wx.error(function (err) {
                return resolve(err);
              });
            });

          case 13:
            callback();
            if (cbList.length) {
              cbList.forEach(function (cb) {
                return cb();
              });
              cbList = [];
            }

          case 16:
          case 'end':
            return _context.stop();
        }
      }
    }, _callee, this);
  }));

  function loadWx() {
    return _ref.apply(this, arguments);
  }

  return loadWx;
})();

function requestJsbill() {
  return new Promise(function (resolve, reject) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/lens/fit/h5/api/v1/wechat/jsbill?type=1&url=' + encodeURIComponent(window.location.href));
    xhr.send(null);
    xhr.onreadystatechange = function () {
      if (xhr.status === 200) {
        if (xhr.readyState === 4) {
          resolve(JSON.parse(xhr.responseText));
        }
      }
    };
  });
}

var _wx = new Proxy(wx, {
  get: function get(target, name) {
    if (!isWeChat()) {
      return function () {
        console.log('当前不是微信环境 跳过jsdk配置');
      };
    } else if (name in target) {
      return wx[name];
    } else {
      return function () {
        for (var _len = arguments.length, arg = Array(_len), _key = 0; _key < _len; _key++) {
          arg[_key] = arguments[_key];
        }

        loadWx(function () {
          return wx[name].apply(wx, arg);
        }).catch(function (err) {
          return console.log(err);
        });
      };
    }
  }
});

var index = {
  install: function install(Vue) {
    Object.defineProperty(Vue.prototype, '$wx', {
      value: _wx
    });
    Object.defineProperty(window, 'wx', {
      value: _wx
    });
    loadWx().catch(function (err) {
      return console.log(err);
    });
  },

  init: loadWx
};

export default index;
